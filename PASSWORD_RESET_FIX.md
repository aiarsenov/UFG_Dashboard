# Исправление проблемы с восстановлением пароля

## Проблема
При переходе по ссылке для восстановления пароля получаем ошибку:
```json
{"code":403,"error_code":"otp_expired","msg":"Email link is invalid or has expired"}
```

## Исправления в коде (выполнено)

### 1. Улучшена обработка токенов в `/auth/callback/route.ts`
- Добавлена поддержка обмена `code` на сессию через `exchangeCodeForSession`
- Улучшена обработка `token_hash` через `verifyOtp`
- Правильная обработка обоих форматов токенов, которые может отправлять Supabase

### 2. Улучшена страница `/auth/reset/page.tsx`
- Добавлена обработка токенов из hash-фрагмента URL
- Добавлена проверка query параметров и редирект на callback при необходимости
- Улучшена обработка ошибок и сообщений пользователю

### 3. Улучшен API route `/api/auth/reset-password/route.ts`
- Добавлена поддержка обмена `code` на сессию
- Улучшена обработка ошибок с детальными сообщениями
- Добавлено логирование для отладки

## Настройка в Supabase Dashboard (требуется)

### 1. URL Configuration

1. Перейдите в **Authentication** → **URL Configuration**
2. В поле **"Site URL"** укажите: `https://ufg-dashboard.vercel.app` (или ваш домен)
3. В поле **"Redirect URLs"** добавьте:
   - `https://ufg-dashboard.vercel.app/auth/callback`
   - `https://ufg-dashboard.vercel.app/auth/reset`
   - `http://localhost:3000/auth/callback` (для локальной разработки)
   - `http://localhost:3000/auth/reset` (для локальной разработки)
4. Нажмите **"Save"**

### 2. Увеличение времени жизни токена

1. Перейдите в **Authentication** → **Sign In / Providers** → **Email**
2. Найдите **"Email OTP Expiration"**
3. Увеличьте значение с `3600` (1 час) до `86400` (24 часа) или больше
4. Нажмите **"Save"**

### 3. Проверка Email Templates

1. Перейдите в **Authentication** → **Email Templates**
2. Найдите шаблон **"Reset Password"**
3. Убедитесь, что в шаблоне используется правильный redirect URL:
   ```
   {{ .ConfirmationURL }}
   ```
   Это автоматически подставит правильный URL с токеном

## Как это работает

1. Пользователь запрашивает восстановление пароля на `/auth/forgot`
2. Supabase отправляет письмо со ссылкой
3. Ссылка ведет на Supabase домен, который редиректит на `/auth/callback?type=recovery&code=...`
4. Callback route обменивает `code` на сессию и редиректит на `/auth/reset`
5. Страница reset проверяет сессию и позволяет установить новый пароль

## Проверка

После настройки в Supabase:
1. Запросите восстановление пароля на `/auth/forgot`
2. Проверьте письмо - ссылка должна вести на ваш домен через Supabase
3. Перейдите по ссылке - должна открыться форма сброса пароля
4. Установите новый пароль - должно работать без ошибок



